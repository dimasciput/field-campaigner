{% extends 'new_base.html' %}

{% block title %} Home {% endblock %}

{% block content %}

    <script type="text/javascript">
        var allCampaignPosition = [];
    </script>

    <div class="row">
        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-map-o" aria-hidden="true"></i> Campaign Map
                    <div class="pull-right">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                Actions
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu pull-right" role="menu">
                                <li><a href="#">Action</a>
                                </li>
                                <li><a href="#">Another action</a>
                                </li>
                                <li><a href="#">Something else here</a>
                                </li>
                                <li class="divider"></li>
                                <li><a href="#">Separated link</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div id="campaign-map"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">

                <button id="create-campaign" type="button" class="btn btn-outline btn-primary btn-lg btn-block">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                    <span style="margin-left: 5px;">Create New Campaign</span>
                </button>

            <div class="panel panel-default" style="margin-top: 20px;">
                <div class="panel-heading">
                    <i class="fa fa-list-ul" aria-hidden="true"></i> Campaigns
                </div>
                <div id="panel-campaign">
                    <div class="panel-body">
                    <table id="campaign-table">
                        <thead>
                            <tr>
                                <th>
                                    Name
                                </th>
                                <th>
                                    Tags
                                </th>
                                <th>
                                    Action
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for campaign in campaigns %}
                                <tr>
                                    <td>
                                        <a href="campaign/{{ campaign.uuid }}">{{ campaign.name }}</a>
                                    </td>
                                    <td class="tag">
                                        {% if campaign.tags %}
                                            {% for tag in campaign.tags %}
                                                <a href="/campaign_manager/tags/{{ tag }}">{{ tag }}</a>
                                                {% if tag != campaign.tags[-1] %}
                                                    ,
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" href="#" class="btn btn-outline btn-info campaign-list campaign-list-disabled"
                                           data-managers="{{ campaign.campaign_managers}}" data-uuid="{{ campaign.uuid }}">
                                                <span class="pull-left">Manage</span>
                                        </button>
                                    </td>
                                </tr>
                                <script type="text/javascript">
                                    var geometry = {{ campaign.geometry | safe }};
                                    geometry.features[0]['properties']['name'] = "{{ campaign.name }}";
                                    geometry.features[0]['properties']['uuid'] = "{{ campaign.uuid }}";
                                    allCampaignPosition.push(geometry);
                                </script>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>


        </div>

    </div>

{% endblock %}

{% block before_base_js %}

    <style type="text/css">


        #campaign-table, #campaign-table_wrapper {
            font-size: 10pt;
        }

        #campaign-table_info {
            font-size: 9pt;
        }

        .paginate_button {
            padding: 0.3em 0.7em !important;
        }

        #campaign-table_wrapper {
            padding-bottom: 20px;
            padding-top: 10px;
        }

        #campaign-table .tag {
            font-size: 9pt;
        }

        #campaign-table_filter input[type=search] {
            border-radius: 4px;
            border: 1px solid #d1d1d1;
        }

        #campaign-table tr.odd {
            background-color: rgba(223, 234, 242, 0.30) !important;
        }


        #campaign-table tr.odd:hover, tr.even:hover {
            background-color: rgba(59, 132, 172, 0.13) !important;
        }

    </style>

    <script type="text/javascript">

        var map = L.map('campaign-map').setView([0, 0], 1);
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="http://www.openstreetmap.org" target="_parent">OpenStreetMap</a> and contributors, ' +
            'under an <a href="http://www.openstreetmap.org/copyright" target="_parent">open license</a>',
            maxZoom: 15
        }).addTo(map);

        $.each(allCampaignPosition, function(index, campaign){
            var campaignLayer = L.geoJson(campaign, {
                onEachFeature: function (feature, layer) {
                    // Check if feature is a polygon
                    if (feature.geometry.type === 'Polygon') {
                        // Don't stroke and do opaque fill
                        layer.setStyle({
                            'weight': 0.3,
                            'fillOpacity': 0.5,
                            'color': '#FF5722'
                        });
                    }
                }
            }).addTo(map);

            var bounds = campaignLayer.getBounds();
            var center = bounds.getCenter();

            var marker = L.marker(center, {icon: orangeIcon}).addTo(map);
            marker.bindPopup(
                '<div class="campaign-marker"><a href="campaign/'+
                campaign['features'][0]['properties']['uuid'] +'"> ' +
                campaign['features'][0]['properties']['name'] +
                '</a></div>'
            );
        });

        $('#create-campaign').click(function () {
            if (window.isAuthenticated) {
                location.href='create';
            } else {
                showNotifications('You need to login first.', 'danger');
            }
        });

    </script>

{% endblock %}

{% block after_base_js %}

    <script type="text/javascript">

        $(function () {
            $('#campaign-table').DataTable();
        });

        function updated(user) {

            var currentUser = user.display_name;
            var $campaignListElement = $('#panel-campaign').children().find('.campaign-list-disabled');

            for(var i=0; i < $campaignListElement.length; i++) {

                var $campaign = $($campaignListElement[i]);
                var managers = JSON.parse($campaign.attr('data-managers').replace(/'/g, '"'));

                if(containsObject(currentUser, managers)) {
                    $campaign.show();
                } else {
                    $campaign.hide();
                }
            }
        }

        function logoutSuccess() {
            var $campaignListElement = $('#panel-campaign').children().find('.campaign-list-disabled');
            for(var i=0; i < $campaignListElement.length; i++) {
                $($campaignListElement[i]).hide();
            }
        }

        $('.campaign-list').click(function () {
            location.href='edit/' + $(this).attr('data-uuid');
        });

        $('#panel-campaign .panel-body .panel-body').click(function(){
            location.href='campaign/' + $(this).parent().attr('data-uuid');
        });

        $('#panel-campaign .panel-body .panel-heading').click(function(){
            location.href='campaign/' + $(this).parent().attr('data-uuid');
        });

    </script>

{% endblock %}